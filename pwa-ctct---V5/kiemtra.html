<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PTKV3 ‚Ä¢ L√†m b√†i ki·ªÉm tra</title>
<link rel="stylesheet" href="css/nav.css?v=20251006">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
/* ===== NAVBAR (ƒë·ªôc l·∫≠p) ===== */
:root{--gold:#FFD966; --red-a:#7f1d1d; --red-b:#b91c1c; --red-c:#dc2626;
  --topbar-grad: linear-gradient(90deg, var(--red-a) 0%, var(--red-b) 45%, var(--red-c) 100%);}; 
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
a{color:inherit;text-decoration:none}

/* Top bar */
.header{position:sticky;top:0;z-index:50; font-weight: 600;  background: var(--topbar-grad); border-bottom: 2px solid #FFD74B;}
.nav{  max-width:1200px; margin:auto;
  height:56px;                         /* ƒë·ªìng b·ªô chi·ªÅu cao */
  padding:0px 16px;                       /* gi√£n c√°ch ngang */
  display:flex; align-items:center; gap:18px;  /* kho·∫£ng c√°ch item */
  font-size:16px; line-height:1;        /* c·ª° ch·ªØ & line-height nh∆∞ trang H·ªçc t·∫≠p */
  font-weight:600;}
.nav a:hover{color:var(--gold); transform:scale(1.06);}
.brand{font-weight:800; letter-spacing:0.2px}
.nav a{ color:#fff; padding:6px 12px; border-radius:12px;}

.nav .is-active{background: rgba(0,0,0,.15);box-shadow:0 4px 12px rgba(0,0,0,.18)}

.m-toggle{margin-left:auto;background:transparent;border:0;color:#fff;font-size:28px;display:none}
/* Drawer mobile */
@media (max-width:1024px){
  .nav a:not(.brand),.has-dropdown{display:none}
  .m-toggle{display:block}
  .drawer{position:fixed;inset:0 auto 0 0;width:86vw;max-width:420px;background:linear-gradient(180deg,#7f1d1d,#b91c1c 55%,#9d1414);color:#fff;transform:translateX(-100%);transition:.25s;z-index:60;box-shadow:4px 0 30px rgba(0,0,0,.25)}
  .drawer.open{transform:translateX(0)}
  .d-head{display:flex;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.12)}
  .d-menu{padding:8px}
  .d-item{display:block;color:#fff;padding:12px;border-bottom:1px solid rgba(255,255,255,.08)}
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);z-index:55;opacity:0;pointer-events:none;transition:.25s}
  .backdrop.open{opacity:1;pointer-events:auto}
}
/* ·∫®n ch·∫Øc ch·∫Øn drawer/backdrop tr√™n desktop */
@media (min-width:1025px){ .drawer,.backdrop{display:none !important;transform:none !important} }

/* ===== PAGE BACKGROUND ===== */
.page{
  background:
    linear-gradient(90deg, var(--red-a) 0%, var(--red-b) 45%, var(--red-c) 100%),
    /* hai radial nh·∫π ƒë·ªÉ t·∫°o chi·ªÅu s√¢u ‚Äì c√πng h∆∞·ªõng, kh√¥ng ƒë·∫£o */
    radial-gradient(900px 420px at 12% 15%, rgba(255,255,255,.06) 0%, transparent 70%),
    radial-gradient(900px 420px at 88% 25%, rgba(0,0,0,.12) 0%, transparent 65%);
  min-height:100svh;
  color:#0f172a;
}
body.bg-red{
  background:
    linear-gradient(90deg, var(--red-a) 0%, var(--red-b) 45%, var(--red-c) 100%),
    radial-gradient(900px 420px at 12% 15%, rgba(255,255,255,.06) 0%, transparent 70%),
    radial-gradient(900px 420px at 88% 25%, rgba(0,0,0,.12) 0%, transparent 65%);
}

/* ===== HERO ===== */
.hero{max-width:1200px;margin:0 auto;padding:16px 16px 8px;color:#fff}
.hero h1{margin:6px 0;font-size:clamp(28px,4vw,48px);line-height:1.08;color:#F3C63F;font-weight:800}
.hero p{margin:0;color:#FFE6BF}

/* ===== GRID ===== */
.grid{max-width:1200px;margin:22px auto;padding:0 16px 20px;display:grid;gap:22px;grid-template-columns:1fr}
@media (min-width:768px){.grid{grid-template-columns:1fr 1fr}}
@media (min-width:1100px){.grid{grid-template-columns:1fr 1fr 1fr}}

/* ===== CARD ===== */
.card{
      background:#fffaf0; /* üåº N·ªÅn s√°ng ng√† kem, n·ªïi tr√™n n·ªÅn ƒë·ªè */
  border:3px solid #FFD74B;
  box-shadow:0 0 12px rgba(255,215,75,.35);
  border-radius:14px;
  padding:18px 18px 14px;
  height:260px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
.card__title{margin:0;font-size:22px;font-weight:800;color:#1a1d25}
.meta{display:grid;gap:8px;font-size:15px;color:#1f2937}
.row{display:flex;align-items:center;gap:10px}
.icon{width:18px;height:18px;display:inline-block}

/* Buttons ‚Äì ƒë·ªìng b·ªô, ring m·∫£nh, cƒÉn gi·ªØa & th·∫≥ng h√†ng */
.actions{margin-top:16px;display:flex;justify-content:center;}
.btn{
  min-width: 180px;     /* ƒë·ªìng ƒë·ªÅu k√≠ch th∆∞·ªõc */
  padding: 8px 14px;    /* gi·∫£m chi·ªÅu cao */
  font-size: 14px; font-size: 16px;
  font-weight: 700;
  border-radius: 8px;
  text-transform: uppercase;
  border: 2px solid #FFD74B;  /* vi·ªÅn v√†ng */
  background: #C62828;        /* ƒë·ªè s√°ng */
  color: #fff;
  box-shadow: 0 0 6px rgba(255,215,75,.4);
  transition: all .2s ease;
}
.btn:active{transform:translateY(1px)}
.btn-primary, .btn-ghost{
  background:#C62828;              /* ƒë·ªè s√°ng h∆°n */
  color:#fff;
  border:2px solid #FFD74B;        /* vi·ªÅn v√†ng */
  box-shadow:0 0 8px rgba(255,215,75,.5); /* √°nh s√°ng v√†ng quanh n√∫t */
}
.btn-primary:hover, .btn-ghost:hover{
  filter:brightness(1.1);
}

/* Footer */
.footer{color:#FFE6A6;text-align:center;padding:14px 16px 18px;border-top:1px solid rgba(255,255,255,.12)}
</style>
</head>
<body>
<script>
(function(){
  try{
    const t = localStorage.getItem('ctct_token') || sessionStorage.getItem('ctct_token');
    if(!t || t === 'null' || t === 'undefined'){
      const back = encodeURIComponent(location.href);
      location.replace(`login.html?redirect=${back}`);
    }
  }catch(e){}
})();
</script>

<!-- ===== NAVBAR ===== -->
<header class="header">
  <nav class="nav">
    <a class="brand">BAN CH·ªà HUY PTKV3</a>
    <a href="index.html">Trang ch·ªß</a>
    <a href="tintuc24.html">Tin t·ª©c</a>
    <a href="Hoctap.html">H·ªçc t·∫≠p</a>
    <a href="#" aria-current="page" style="background:rgba(31, 28, 28, 0.18)">Ki·ªÉm tra</a>
    <div class="sp"></div>
    <button id="hamburger" class="m-toggle" aria-label="M·ªü menu">‚ò∞</button>
  </nav>

  <!-- Drawer mobile -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="d-head">
      <strong>B·ªò CHQS T·ªàNH B·∫ÆC NINH</strong>
      <button id="close" style="margin-left:auto;background:0 0;border:0;color:#fff;font-size:26px">‚úï</button>
    </div>
    <nav class="d-menu">
      <a class="d-item" href="index.html">Trang ch·ªß</a>
      <a class="d-item" href="tintuc24.html">Tin t·ª©c</a>
      <a class="d-item" href="Hoctap.html">H·ªçc t·∫≠p</a>
      <a class="d-item" href="kiemtra.html" aria-current="page" style="background:rgba(255,255,255,.16);border-left:3px solid var(--gold);font-weight:800">L√†m b√†i ki·ªÉm tra</a>
      </nav>
  </div>
  <div id="backdrop" class="backdrop"></div>
</header>

<!-- ===== PAGE ===== -->
<main class="page">
  <section class="hero">
    <h1>KI·ªÇM TRA CH√çNH TR·ªä NƒÇM 2025</h1>
    <p>ƒê√°nh gi√° nh·∫≠n th·ª©c ‚Äì Ki·ªÉm tra k·∫øt qu·∫£ hu·∫•n luy·ªán</p>
  </section>

    <section class="grid" id="exam-grid">
    <!-- Fallback khi ƒëang t·∫£i -->
    <article class="card" id="loading-card">
      <header class="row" style="align-items:flex-start">
        <h2 class="card__title">ƒêang t·∫£i danh s√°ch k·ª≥ thi‚Ä¶</h2>
      </header>
      <div class="meta loading">
        Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t.
      </div>
      <div class="actions"><button class="btn btn-primary" disabled>ƒêANG T·∫¢I</button></div>
    </article>
  </section>

  <footer class="footer">¬© PTKV3 ‚Äì Trung t√¢m Gi√°o d·ª•c Ch√≠nh tr·ªã S·ªë</footer>
</main>

<!-- ====== PTKV3 CORE (startExam) ====== -->
<script>
window.PTKV3_CFG = {
  RESULT_PAGE: "ketqua.html",
  EXAM_PAGE:   "lambai.html",
  SUBMIT_URL:  "",
  USE_QUEUE:   true
};
(function(){
  const KEYS = { CURRENT:"ptkv3:exam:current" };
  function save(k,v){ try{ sessionStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
  window.PTKV3 = window.PTKV3 || {};
  window.PTKV3.startExam = function(meta){
    const cfg = {
      mode: meta.mode || "exam",
      bankId: meta.bankId || "UNKNOWN",
      title: meta.title || "",
      total: Number(meta.total || 0),
      durationSec: Number(meta.durationSec || 0) || null,
      startedAt: Date.now(),
      user: meta.user || null
    };
    save(KEYS.CURRENT, cfg);
    const p = new URLSearchParams({ bank: cfg.bankId, mode: cfg.mode });
    location.href = window.PTKV3_CFG.EXAM_PAGE + "?" + p.toString();
  };
})();
</script>

<!-- ====== Render ƒë·ªông t·ª´ Apps Script: listBanks ====== -->
<script>
const API = 'https://script.google.com/macros/s/DEPLOYMENT_ID/exec'; // TODO: thay DEPLOYMENT_ID
const grid = document.getElementById('exam-grid');

function fmtDate(ts){
  if(!ts) return '‚Äî';
  const d = new Date(ts);
  return d.toLocaleDateString('vi-VN', {day:'2-digit', month:'2-digit', year:'numeric'});
}

function attachStartHandlers(scope){
  scope.querySelectorAll('button[data-bank]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(btn.disabled) return;
      PTKV3.startExam({
        bankId: btn.dataset.bank,
        title: btn.dataset.title,
        total: Number(btn.dataset.total||0),
        durationSec: Number(btn.dataset.duration||0) || null,
        mode: btn.dataset.mode || 'exam'
      });
    });
  });
}

function renderBanks(banks){
  grid.innerHTML = '';
  if(!banks.length){
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <header class="row" style="align-items:flex-start">
        <h2 class="card__title">Ch∆∞a c√≥ k·ª≥ ki·ªÉm tra</h2>
      </header>
      <div class="meta">H√£y ki·ªÉm tra b·∫£ng <strong>Banks</strong> trong Google Sheet ho·∫∑c th·ªùi gian m·ªü k·ª≥ thi.</div>
      <div class="actions"><button class="btn btn-ghost" disabled>‚Äî</button></div>
    `;
    grid.appendChild(card);
    return;
  }

  banks.forEach(b=>{
    const total   = b.totalOverride || b.total || '';
    const status  = b.status || 'open';
    const isDone  = !!b.completed;
    const disabled = (status!=='open' && !isDone) ? 'disabled' : '';

    const badgeStatus = status==='open' ? '' :
      `<span class="status" style="margin-left:8px;padding:2px 8px;border-radius:999px;font-weight:800;font-size:12px;
         ${status==='upcoming'?'background:#fff;color:#7a4b00;':'background:#0003;color:#fff;'}">
         ${status==='upcoming'?'S·∫Øp m·ªü':'ƒê√£ k·∫øt th√∫c'}</span>`;

    const badgeDone = isDone
      ? `<span class="status" style="margin-left:8px;padding:2px 8px;border-radius:999px;font-weight:800;font-size:12px;background:#065f46;color:#fff">ƒê√É HO√ÄN TH√ÄNH</span>`
      : '';

    // N√∫t h√†nh ƒë·ªông
    let actionHtml = '';
    if(isDone && b.last){
      const q = new URLSearchParams({
        correct: String(b.last.correct ?? ''),
        total: String(b.last.total ?? ''),
        time:  (b.last.spentSec!=null
                ? (m=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`)(b.last.spentSec)
                : ''),
        bank:  b.bankId,
        mode:  b.mode || 'exam'
      });
      actionHtml = `<a class="btn btn-primary" href="ketqua.html?${q.toString()}">XEM K·∫æT QU·∫¢</a>`;
    } else {
      const label = (b.mode==='mock' ? 'B·∫ÆT ƒê·∫¶U THI' : 'B·∫ÆT ƒê·∫¶U KI·ªÇM TRA');
      actionHtml = `<button class="btn btn-primary" ${disabled}
                      data-bank="${b.bankId}"
                      data-title="${b.title}"
                      data-total="${total||0}"
                      data-duration="${b.durationSec||''}"
                      data-mode="${b.mode||'exam'}">${label}</button>`;
    }

    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <header class="row" style="align-items:flex-start">
        <h2 class="card__title">${b.title}</h2>${badgeDone || badgeStatus}
      </header>
      <div class="meta">
        <div class="row"><span class="icon">üìÖ</span><span>B·∫Øt ƒë·∫ßu: ${fmtDate(b.startAt)}</span></div>
        <div class="row"><span class="icon">‚è∞</span><span>K·∫øt th√∫c: ${fmtDate(b.endAt)}</span></div>
        <div class="row"><span class="icon">üìù</span><span>${total||'‚Äî'} c√¢u h·ªèi</span></div>
        ${isDone && b.last ? `<div class="row"><span class="icon">üèÅ</span>
          <span>ƒêi·ªÉm g·∫ßn nh·∫•t: <strong>${b.last.correct}/${b.last.total}</strong> ‚Äì Th·ªùi gian: ${
            (m=>`${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`)(b.last.spentSec||0)
          }</span></div>` : ``}
      </div>
      <div class="actions">${actionHtml}</div>
    `;
    grid.appendChild(card);
  });

  attachStartHandlers(grid);
}

async function loadBanks(){
  try{
    const res = await fetch(`${API}?action=listBanks`);
    const data = await res.json();
    if(!data.ok || !Array.isArray(data.banks)){
      throw new Error(data.error || 'listBanks failed');
    }
    renderBanks(data.banks);
  }catch(e){
    console.error(e);
    // Fallback: hi·ªÉn th·ªã th√¥ng b√°o nh∆∞ng kh√¥ng ph√° layout
    const loading = document.getElementById('loading-card');
    if(loading) loading.remove();
    const card = document.createElement('article');
    card.className = 'card';
    card.innerHTML = `
      <header class="row" style="align-items:flex-start">
        <h2 class="card__title">Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch k·ª≥ thi</h2>
      </header>
      <div class="meta err">Vui l√≤ng ki·ªÉm tra Apps Script Web App (action=listBanks).</div>
      <div class="actions"><a class="btn btn-ghost" href="kiemtra.html">T·∫¢I L·∫†I</a></div>`;
    grid.appendChild(card);
  }
}
loadBanks();

/* Drawer mobile nh·ªè g·ªçn (gi·ªØ nguy√™n h√†nh vi) */
const d=document,drawer=d.getElementById('drawer'),bd=d.getElementById('backdrop');
d.getElementById('hamburger')?.addEventListener('click',()=>{drawer.classList.add('open');bd.classList.add('open')});
d.getElementById('close')?.addEventListener('click',()=>{drawer.classList.remove('open');bd.classList.remove('open')});
bd?.addEventListener('click',()=>{drawer.classList.remove('open');bd.classList.remove('open')});
</script>
</body>
</html>
