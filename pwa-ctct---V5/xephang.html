<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>B·∫£ng x·∫øp h·∫°ng ‚Äì PTKV3</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --primary:#A41919; --accent:#FFD966; --bg:#FFF8ED; --text:#0f172a;
  --muted:#6b7280; --border:#e5e7eb; --radius:14px;
  --panel:#0f253f; --panel-2:#122b48; --shadow:0 14px 34px rgba(0,0,0,.22), 0 3px 10px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:var(--bg);display:flex;flex-direction:column}

/* ===== Header/ Footer (ƒë·ªìng b·ªô Hoctap.html) ===== */
.header{position:sticky;top:0;z-index:50;font-weight:600;background:linear-gradient(90deg,#7f1d1d,#b91c1c 45%,#dc2626);color:#fff}
.nav{max-width:1200px;margin:auto;display:flex;gap:18px;align-items:center;padding:12px 16px}
.nav .brand{font-weight:800}
.nav a{color:#fff;padding:6px 10px;border-radius:8px;text-decoration:none}
.nav a[aria-current="page"]{background:rgba(0,0,0,.18)}
.nav a:hover{color:var(--accent);transform:scale(1.04)}
.footer{margin-top:40px;background:#111827;color:#cbd5e1}
.footer .wrap{max-width:1200px;margin:auto;padding:20px 16px;font-size:14px;text-align:center}

/* Dropdown (desktop) */
.nav .has-dropdown{position:relative}
.nav .has-dropdown > a{display:inline-flex;align-items:center;gap:6px}
.nav .dropdown{
  position:absolute;top:calc(100% + 8px);left:0;min-width:220px;display:none;
  background:#1f2937;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px;z-index:60
}
.nav .dropdown a{display:block;color:#e5e7eb}
.nav .has-dropdown:hover .dropdown{display:block}

/* ===== Mobile drawer ===== */
/* ·∫®n m·∫∑c ƒë·ªãnh tr√™n desktop */
.m-drawer{display:none}
.m-backdrop{display:none}
[hidden]{display:none!important}

.m-toggle{display:none!important;background:transparent;border:0;color:#fff;font-size:28px;line-height:1}

@media (max-width:1024px){
  .nav a:not(.brand), .nav .has-dropdown{display:none!important}
  .m-toggle{display:block!important;margin-left:auto}

  .m-drawer{
    display:block;                      /* ch·ªâ hi·ªán ·ªü mobile */
    position:fixed; inset:0 auto 0 0; width:86vw; max-width:420px;
    transform:translateX(-100%);
    background:linear-gradient(180deg,#7f1d1d,#b91c1c 55%,#9d1414);
    color:#fff; z-index:120; transition:transform .25s ease;
    box-shadow:4px 0 30px rgba(0,0,0,.25);
  }
  .m-head{display:flex; align-items:center; gap:10px; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.12)}
  .m-home{font-size:22px; text-decoration:none; color:#fff}
  .m-brand{font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .m-close{margin-left:auto; background:0 0; border:0; color:#fff; font-size:28px; cursor:pointer}

  .m-menu{padding:8px 8px 18px}
  .m-item{display:block; color:#fff; padding:14px 10px; font-weight:600; border-bottom:1px solid rgba(255,255,255,.08); text-decoration:none}
  .m-sub{display:flex; flex-direction:column; gap:6px; padding:10px 10px 12px}
  .m-sub[hidden]{display:none!important}
  .m-drop .caret{float:right}
  .m-drop[aria-expanded="true"] .caret{transform:rotate(180deg)}

  .m-backdrop{display:block; position:fixed; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(2px);
    z-index:110; opacity:0; transition:opacity .25s; pointer-events:none}
  body.menu-open .m-drawer{transform:translateX(0)}
  body.menu-open .m-backdrop{opacity:1; pointer-events:auto}
  body.no-scroll{overflow:hidden}

  .m-menu .m-item[aria-current="page"]{
    background: rgba(255,255,255,.16);
    border-left: 3px solid #FFD966;
    font-weight: 800;
  }
}

/* ===== Title ribbon ===== */
.title{
  width:100%;min-height:44px;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(180deg,#9F1B16 0%, #7F1212 100%);color:#FFD966;
  font-weight:900;letter-spacing:.5px;box-shadow:inset 0 -2px 0 rgba(0,0,0,.08),0 4px 12px rgba(0,0,0,.08)
}

/* ===== Main ===== */
main{flex:1 0 auto}
.container{max-width:1200px;margin:22px auto 30px;padding:0 16px}

/* Controls */
.controls{
  display:grid;grid-template-columns:1fr auto auto auto auto;gap:10px;
  background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 8px 18px rgba(0,0,0,.06)
}
.controls .search{position:relative}
.controls .search input{
  width:100%;padding:12px 12px 12px 36px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#111
}
.controls .search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.65}
select,.btn{appearance:none;padding:12px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;color:#111;font-weight:600;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#FFD966,#E6C34D);color:#5b4300;border:0}

/* Tabs */
.tabs{display:flex;gap:8px;margin:14px 0}
.tab{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#111;font-weight:800;cursor:pointer}
.tab.active{background:#FFD966;color:#5b4300}

/* Table card */
.card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border-radius:18px;border:1px solid rgba(0,0,0,.08);box-shadow:var(--shadow);color:#fff}
.table-wrap{overflow:auto;border-radius:18px}
.table{width:100%;border-collapse:separate;border-spacing:0;min-width:760px}
.table th,.table td{padding:12px 14px;text-align:left}
.table thead th{position:sticky;top:0;background:#0f253f;color:#dbeafe;z-index:1;border-bottom:1px solid rgba(255,255,255,.08)}
.table tr:not(:first-child) td{border-top:1px solid rgba(255,255,255,.06)}
.badge-rank{display:inline-flex;align-items:center;justify-content:center;min-width:34px;height:34px;border-radius:10px;font-weight:800;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15)}
.badge-rank.top1{background:linear-gradient(180deg,#ffd966,#e6c34d);color:#5b4300}
.badge-rank.top2{background:#e5e7eb;color:#111827}
.badge-rank.top3{background:#f59e0b;color:#1f2937}
.pill{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:#fff;border:1px solid var(--border);color:#374151}

/* Mobile layout */
@media (max-width:960px){
  .controls{grid-template-columns:1fr 1fr 1fr;grid-auto-rows:auto}
  .controls .search{grid-column:1/-1}
}
@media (max-width:640px){
  .title{font-size:16px}
  .controls{grid-template-columns:1fr 1fr;grid-auto-rows:auto}
  .controls .search{grid-column:1/-1}
  .tab{flex:1;text-align:center}
}
/* R·∫•t nh·ªè: ƒë·ªïi h√†ng b·∫£ng th√†nh th·∫ª */
@media (max-width:560px){
  .table{min-width:0}
  .table thead{display:none}
  .table tr{display:block;border-top:1px solid rgba(255,255,255,.1);padding:10px 12px}
  .table td{display:block;padding:6px 0}
  .table td:first-child{padding-top:0}
}

</style>
</head>
<body>

<!-- ===== HEADER ===== -->
<header class="header">
  <nav class="nav" role="navigation" aria-label="ƒêi·ªÅu h∆∞·ªõng ch√≠nh">
    <a class="brand" href="index.html">BAN CH·ªà HUY PTKV3</a>
    <a href="index.html">Trang ch·ªß</a>
    <a href="tintuc24.html">Tin t·ª©c</a>
    <a href="Hoctap.html">H·ªçc t·∫≠p</a>
    <a href="kiemtra.html">Ki·ªÉm tra</a>
    <div class="nav__item has-dropdown">
      <a href="#" aria-haspopup="true" aria-expanded="false">K·∫øt qu·∫£ ki·ªÉm tra ‚ñæ</a>
      <div class="dropdown" role="menu" aria-label="K·∫øt qu·∫£ ki·ªÉm tra">
        <a href="my-results.html" role="menuitem">K·∫øt qu·∫£ c·ªßa t√¥i</a>
        <a href="leaderboard.html" role="menuitem" aria-current="page">B·∫£ng x·∫øp h·∫°ng</a>
      </div>
    </div>
    <div class="sp"></div>
    <button class="m-toggle" aria-label="M·ªü menu">‚ò∞</button>
  </nav>
</header>

<!-- ===== MOBILE DRAWER ===== -->
<aside id="mDrawer" class="m-drawer" aria-hidden="true" role="dialog" aria-label="Menu">
  <div class="m-head">
    <a class="m-home" href="index.html" aria-label="Trang ch·ªß" title="Trang ch·ªß">üè†</a>
    <span class="m-brand">BAN CH·ªà HUY PTKV3</span>
    <button class="m-close" aria-label="ƒê√≥ng menu">‚úï</button>
  </div>
  <nav class="m-menu" role="navigation" aria-label="Menu di ƒë·ªông">
    <a class="m-item" href="index.html">Trang ch·ªß</a>
    <a class="m-item" href="tintuc24.html">Tin t·ª©c</a>
    <a class="m-item" href="Hoctap.html">H·ªçc t·∫≠p</a>
    <a class="m-item" href="kiemtra.html">Ki·ªÉm tra</a>
    <button class="m-item m-drop" data-target="#m-result" aria-controls="m-result" aria-expanded="false">
      K·∫øt qu·∫£ ki·ªÉm tra <span class="caret">‚ñæ</span>
    </button>
    <div id="m-result" class="m-sub" hidden>
      <a href="my-results.html">K·∫øt qu·∫£ c·ªßa t√¥i</a>
      <a href="leaderboard.html" aria-current="page">B·∫£ng x·∫øp h·∫°ng</a>
    </div>
  </nav>
</aside>
<div class="m-backdrop" hidden></div>

<div class="title">B·∫¢NG X·∫æP H·∫†NG</div>

<main>
  <div class="container">
    <!-- Controls -->
    <div class="controls" role="region" aria-label="B·ªô l·ªçc x·∫øp h·∫°ng">
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="#111" stroke-width="2" opacity=".6"/></svg>
        <input id="q" placeholder="T√¨m t√™n, ƒë∆°n v·ªã...">
      </div>
      <select id="exam"><option value="">‚Äî T·∫•t c·∫£ k·ª≥ thi ‚Äî</option></select>
      <select id="range">
        <option value="day">H√¥m nay</option>
        <option value="week" selected>Tu·∫ßn n√†y</option>
        <option value="month">Th√°ng n√†y</option>
        <option value="year">NƒÉm nay</option>
        <option value="all">T·∫•t c·∫£</option>
      </select>
      <select id="sort">
        <option value="percent">% cao nh·∫•t</option>
        <option value="correct">S·ªë ƒë√∫ng</option>
        <option value="time">Th·ªùi gian (nhanh)</option>
        <option value="submittedAt">M·ªõi nh·∫•t</option>
      </select>
      <button class="btn primary" id="btnRefresh">L√†m m·ªõi</button>
    </div>

    <!-- Tabs -->
    <div class="tabs" role="tablist">
      <button class="tab active" role="tab" aria-selected="true" id="tab-individual">C√° nh√¢n</button>
      <button class="tab" role="tab" aria-selected="false" id="tab-unit">T·∫≠p th·ªÉ</button>
    </div>

    <!-- Board -->
    <section class="card" id="board">
      <div class="table-wrap">
        <table class="table" aria-describedby="caption">
          <caption id="caption" style="position:absolute;left:-9999px">B·∫£ng x·∫øp h·∫°ng</caption>
          <thead>
            <tr>
              <th style="width:80px">#</th>
              <th>H·ªç t√™n / ƒê∆°n v·ªã</th>
              <th style="width:120px">% ƒë√∫ng</th>
              <th style="width:120px">ƒê√∫ng/T·ªïng</th>
              <th style="width:150px">Th·ªùi gian</th>
              <th style="width:170px">N·ªôp l√∫c</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <div class="pill" id="status" style="margin-top:10px;display:inline-flex">ƒêang t·∫£i...</div>
  </div>
</main>

<footer class="footer">
  <div class="wrap">
    <strong>PTKV3 ‚Ä¢ Trung t√¢m Gi√°o d·ª•c Ch√≠nh tr·ªã s·ªë ¬© 2025</strong>
  </div>
</footer>

<!-- ===== C·∫§U H√åNH API (ƒë·∫∑t URL Apps Script th·∫≠t c·ªßa anh) ===== -->
<script>
  window.PTKV3_API = window.PTKV3_API || 'https://script.google.com/macros/s/AKfycbyxGPfoT01trif5STewllIlvyIn_6nYu1VaYYrFAPAuRkKs_wIKOEk4xXHamWFC0Auagg/exec';
</script>

<script>
/** ===== Utils ===== */
const $=(s,r=document)=>r.querySelector(s); const qs=(s,r=document)=>[...r.querySelectorAll(s)];
const pad=n=>String(n).padStart(2,'0');
const pct=n=>(n==null||isNaN(n))?'‚Äî':n.toFixed(0)+'%';
const fmtTime=sec=>{if(sec==null||isNaN(sec))return'‚Äî';const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;return h?`${pad(h)}:${pad(m)}:${pad(s)}`:`${pad(m)}:${pad(s)}`};
const fmtDate=iso=>{if(!iso)return'‚Äî';const d=new Date(iso);if(isNaN(d))return iso;return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`};
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
function escapeHtml(str){return (str==null)?'':String(str).replace(/[&<>"']/g,s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]))}

/** Chu·∫©n ho√° record t·ª´ API */
function normalizeItem(raw, group){
  const r = raw || {};
  if(group === 'unit'){
    return {
      unit: r.unit || r.donVi || r.team || '',
      percent: Number(r.percent ?? r.avgPercent ?? r.scorePercent ?? r.percentCorrect ?? 0),
      count: Number(r.count ?? r.soNguoi ?? r.memberCount ?? 0),
      correct: null, total: null, durationSec: null, submittedAt: null
    };
  }
  return {
    fullName: r.fullName || r.hoTen || r.name || '',
    unit: r.unit || r.donVi || r.team || '',
    percent: Number(r.percent ?? r.scorePercent ?? r.percentCorrect ?? 0),
    correct: Number(r.correct ?? r.right ?? r.dung ?? 0),
    total: Number(r.total ?? r.tong ?? r.questions ?? 0),
    durationSec: Number(r.durationSec ?? r.timeSec ?? r.seconds ?? 0),
    submittedAt: r.submittedAt || r.ts || r.createdAt || r.submitted_time || ''
  };
}

/** ===== State ===== */
const state={tab:'individual',examId:'',range:'week',sort:'percent',q:''};
const AUTO_REFRESH_MS=60_000;

/** ===== Render ===== */
function setStatus(t){const el=$('#status');el.textContent=t||'';el.style.display=t?'inline-flex':'none'}
function headerByTab(){
  const ths=qs('.table thead th');
  if(state.tab==='unit'){ths[1].textContent='ƒê∆°n v·ªã';ths[2].textContent='% trung b√¨nh';ths[3].textContent='Quy m√¥';ths[4].textContent='‚Äî';ths[5].textContent='‚Äî';}
  else{ths[1].textContent='H·ªç t√™n / ƒê∆°n v·ªã';ths[2].textContent='% ƒë√∫ng';ths[3].textContent='ƒê√∫ng/T·ªïng';ths[4].textContent='Th·ªùi gian';ths[5].textContent='N·ªôp l√∫c';}
}
function rows(items){
  const tb=$('#tbody');tb.innerHTML='';
  if(!items?.length){tb.innerHTML='<tr><td colspan="6" style="text-align:center;color:#cbd5e1;padding:18px">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';return}
  items.forEach((it,i)=>{
    const rank=i+1, cls=rank===1?'top1':rank===2?'top2':rank===3?'top3':'';
    const name=state.tab==='unit'?(it.unit||'‚Äî'):(it.fullName||'‚Äî');
    const unit=state.tab==='unit'?(it.count?`${it.count} ng∆∞·ªùi`:'' ):(it.unit||'');
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><span class="badge-rank ${cls}">${rank}</span></td>
      <td><div style="font-weight:800;color:#fff">${escapeHtml(name)}</div><div style="opacity:.85;font-size:12px;color:#d1d5db">${escapeHtml(unit)}</div></td>
      <td>${pct(it.percent)}</td>
      <td>${it.correct!=null?`${it.correct}/${it.total}`:'‚Äî'}</td>
      <td>${fmtTime(it.durationSec)}</td>
      <td>${fmtDate(it.submittedAt)}</td>`;
    tb.appendChild(tr);
  });
}

/** ===== API ===== */
async function exams(){
  if(!window.PTKV3_API) throw new Error('Thi·∫øu c·∫•u h√¨nh API');
  const rs=await fetch(window.PTKV3_API+'?action=leaderboard&meta=exams',{cache:'no-store'});
  const j=await rs.json().catch(()=>null);
  const arr = j?.exams || j?.data?.exams || [];
  return Array.isArray(arr) ? arr : [];
}
async function board(){
  if(!window.PTKV3_API){setStatus('Thi·∫øu c·∫•u h√¨nh API (window.PTKV3_API)');return}
  setStatus('ƒêang t·∫£i x·∫øp h·∫°ng‚Ä¶');
  const p=new URLSearchParams({action:'leaderboard',group:state.tab,range:state.range,sort:state.sort,examId:state.examId||''});
  const rs=await fetch(window.PTKV3_API+'?'+p.toString(),{cache:'no-store'});
  if(!rs.ok){setStatus('L·ªói HTTP '+rs.status);return}
  const j=await rs.json().catch(()=>null);
  if(!j){setStatus('API r·ªóng');return}
  const rawItems = (j.items || j.data?.items || j.results || []);
  let items = rawItems.map(it => normalizeItem(it, state.tab));
  if(state.q){const q=state.q.toLowerCase();items=items.filter(it=>{const name=state.tab==='unit'?(it.unit||''):(it.fullName||'');const unit=it.unit||'';return name.toLowerCase().includes(q)||unit.toLowerCase().includes(q)})}
  rows(items); setStatus('');
}

/** ===== Init ===== */
(function init(){
  // Drawer mobile
  const drawer=$('#mDrawer'),backdrop=document.querySelector('.m-backdrop'),openBtn=document.querySelector('.m-toggle'),closeBtn=drawer?.querySelector('.m-close');
  const focusables='a,button,[tabindex]:not([tabindex="-1"])'; let lastFocus=null;
  document.querySelectorAll('.m-sub').forEach(p=>p.hidden=true);
  document.querySelectorAll('.m-drop').forEach(b=>b.setAttribute('aria-expanded','false'));
  function open(){lastFocus=document.activeElement;document.body.classList.add('menu-open','no-scroll');drawer?.setAttribute('aria-hidden','false');if(backdrop)backdrop.hidden=false;drawer?.querySelector(focusables)?.focus?.()}
  function close(){document.body.classList.remove('menu-open','no-scroll');drawer?.setAttribute('aria-hidden','true');if(backdrop)backdrop.hidden=true;lastFocus?.focus?.()}
  openBtn?.addEventListener('click',open); closeBtn?.addEventListener('click',close); backdrop?.addEventListener('click',close);
  document.addEventListener('keydown',e=>{if(e.key==='Escape')close()});
  drawer?.addEventListener('click',e=>{const btn=e.target.closest('.m-drop');if(!btn)return;const id=btn.getAttribute('aria-controls')||btn.dataset.target?.replace('#','');const panel=id?document.getElementById(id):null;if(!panel)return;const ex=btn.getAttribute('aria-expanded')==='true';btn.setAttribute('aria-expanded',String(!ex));panel.hidden=ex?true:false});
  drawer?.addEventListener('click',e=>{const a=e.target.closest('a');if(a)close()});

  // Tabs & controls
  $('#tab-individual').addEventListener('click',()=>{state.tab='individual';toggleTabs();board()});
  $('#tab-unit').addEventListener('click',()=>{state.tab='unit';toggleTabs();board()});
  $('#range').addEventListener('change',e=>{state.range=e.target.value;board()});
  $('#sort').addEventListener('change',e=>{state.sort=e.target.value;board()});
  $('#exam').addEventListener('change',e=>{state.examId=e.target.value;board()});
  $('#btnRefresh').addEventListener('click',board);
  $('#q').addEventListener('input',debounce(e=>{state.q=e.target.value.trim();board()},200));
  headerByTab();

  // Load danh s√°ch k·ª≥ thi
  exams().then(list=>{
    list.forEach(ex=>{const o=document.createElement('option');o.value=ex.id;o.textContent=ex.title||ex.id;$('#exam').appendChild(o)})
  }).catch(e=>console.warn('Load exams l·ªói:',e));

  board(); setInterval(board, AUTO_REFRESH_MS);
})();

function toggleTabs(){
  $('#tab-individual').classList.toggle('active', state.tab==='individual');
  $('#tab-unit').classList.toggle('active', state.tab==='unit');
  headerByTab();
}
</script>
</body>
</html>
